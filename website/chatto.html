<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Chat - Negotiation to Booking</title>
    <script>
        const API_URL = 'https://roomhy-backend.onrender.com';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f2f6; 
        }
        .chat-container {
            height: calc(100vh - 80px); /* Full height minus header */
        }
        .chat-messages {
            overflow-y: auto;
            max-height: calc(100% - 140px); /* messages height minus input area */
        }
        .owner-bubble {
            background-color: #3b82f6;
            color: white;
            border-radius: 12px 12px 0 12px;
        }
        .student-bubble {
            background-color: #e5e7eb;
            color: #1f2937;
            border-radius: 12px 12px 12px 0;
        }
        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header (Admin Panel Header) -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-blue-600">Roomhy Admin</a>
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-gray-600">Owner: Mr. Vijay Kumar</span>
                <button class="text-gray-600 hover:text-red-600 p-2 rounded-full">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 chat-container">
        <div class="bg-white rounded-xl shadow-2xl flex h-full overflow-hidden border border-gray-200">
            
            <!-- Sidebar: Chat List -->
            <div class="w-1/3 border-r border-gray-200 bg-gray-50 hidden md:block">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">Bidding Chats (3)</h2>
                </div>
                <!-- Mock Chat List Item 1 (Active) -->
                <div class="p-4 bg-blue-50 border-l-4 border-blue-600 cursor-pointer transition duration-150">
                    <div class="flex justify-between items-start">
                        <div class="font-semibold text-gray-900">Ayush Singh - Athena House</div>
                        <span class="text-xs text-blue-600 font-medium">Active</span>
                    </div>
                    <p class="text-sm text-gray-600 truncate mt-1">Student: That sounds perfect! I accept ₹8500.</p>
                </div>
                <!-- Mock Chat List Item 2 -->
                <div class="p-4 hover:bg-gray-100 cursor-pointer transition duration-150">
                    <div class="flex justify-between items-start">
                        <div class="font-semibold text-gray-800">Priya Sharma - Harmony PG</div>
                        <span class="text-xs text-gray-400">2h ago</span>
                    </div>
                    <p class="text-sm text-gray-500 truncate mt-1">Owner: I can offer ₹9000 as the final rent.</p>
                </div>
                <!-- Mock Chat List Item 3 -->
                <div class="p-4 hover:bg-gray-100 cursor-pointer transition duration-150">
                    <div class="flex justify-between items-start">
                        <div class="font-semibold text-gray-800">Rohan Das - Vistara Residency</div>
                        <span class="text-xs text-gray-400">1d ago</span>
                    </div>
                    <p class="text-sm text-gray-500 truncate mt-1">Owner: Deal finalized. Check the booking link.</p>
                </div>
            </div>

            <!-- Main Chat Window -->
            <div class="flex-1 flex flex-col">
                <!-- Chat Header -->
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800">Ayush Singh (<span class="text-blue-600">Prop: Athena House</span>)</h3>
                    <p class="text-sm text-gray-500">Proposed Bid: ₹8,000 | Current Offer: ₹8,500</p>
                </div>

                <!-- Chat Messages Area -->
                <div id="chat-messages" class="chat-messages p-6 flex-1 space-y-4">
                    
                    <!-- Student Message -->
                    <div class="flex justify-start">
                        <div class="max-w-xs sm:max-w-md p-3 student-bubble shadow-sm">
                            <p class="text-sm">Hi Mr. Kumar, thank you for considering my bid of ₹8000. Is this something we can finalize for the twin-sharing room?</p>
                            <span class="block text-xs text-gray-500 text-right mt-1">10:45 AM</span>
                        </div>
                    </div>

                    <!-- Owner Message -->
                    <div class="flex justify-end">
                        <div class="max-w-xs sm:max-w-md p-3 owner-bubble shadow-sm">
                            <p class="text-sm">Hello Ayush. Your bid is a bit low. I can offer you the room for **₹8,500** per month, all-inclusive. This is my best rate.</p>
                            <span class="block text-xs text-blue-100 text-right mt-1">11:02 AM</span>
                        </div>
                    </div>

                    <!-- Student Message -->
                    <div class="flex justify-start">
                        <div class="max-w-xs sm:max-w-md p-3 student-bubble shadow-sm">
                            <p class="text-sm">That sounds perfect! I accept ₹8500. I am ready to proceed with the documentation and booking process.</p>
                            <span class="block text-xs text-gray-500 text-right mt-1">11:15 AM</span>
                        </div>
                    </div>

                    <!-- Agreement Message Placeholder (Added via JS on button click) -->
                    <!-- This message will be inserted here when 'Agree to Rent' is clicked -->

                </div>

                <!-- Chat Input / Action Area (Bottom) -->
                <div class="p-4 border-t border-gray-200">
                    
                    <!-- Negotiation Input (Visible by default) -->
                    <div id="negotiation-area" class="flex items-center space-x-3">
                        <input type="text" id="message-input" placeholder="Type a message or a new counter-offer..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        
                        <button id="send-button" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex items-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>

                        <button id="agree-button" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition duration-150 shadow-md text-sm font-semibold flex items-center space-x-2">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            <span>Agree to Rent (₹8,500)</span>
                        </button>
                    </div>

                    <!-- Booking Process Panel (Hidden by default) -->
                    <div id="booking-area" class="hidden p-4 bg-green-50 border border-green-300 rounded-lg text-center shadow-lg">
                        <h4 class="text-lg font-bold text-green-700 mb-2 flex items-center justify-center space-x-2">
                            <i data-lucide="wallet" class="w-6 h-6"></i>
                            <span>Agreement Finalized! Next: Booking Process</span>
                        </h4>
                        <p class="text-gray-700 mb-4 text-sm">
                            The terms for Athena House have been agreed upon at **₹8,500/month**. 
                            Click below to generate the rental agreement and process the security deposit.
                        </p>
                        <button id="proceed-booking-button" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition duration-150 shadow-xl font-semibold text-base w-full sm:w-auto">
                            <i data-lucide="key" class="w-5 h-5 mr-2 inline-block"></i>
                            Proceed to Booking Portal
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();

        const chatMessages = document.getElementById('chat-messages');
        const negotiationArea = document.getElementById('negotiation-area');
        const bookingArea = document.getElementById('booking-area');
        const agreeButton = document.getElementById('agree-button');
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message-input');
        
        let isAgreementReached = false;
        
        // Function to scroll chat to the bottom
        function scrollChatToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Simulates sending a new message (Owner side)
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message === "") return;

            // 1. Create new message bubble
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'justify-end');
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="max-w-xs sm:max-w-md p-3 owner-bubble shadow-sm">
                    <p class="text-sm">${message}</p>
                    <span class="block text-xs text-blue-100 text-right mt-1">${time}</span>
                </div>
            `;
            
            // 2. Append and clear input
            chatMessages.appendChild(messageDiv);
            messageInput.value = '';
            
            // 3. Auto-scroll
            scrollChatToBottom();
            
            console.log("Owner Sent Message: " + message);
        });

        // Key Logic: Transition to Booking Process
        agreeButton.addEventListener('click', () => {
            if (isAgreementReached) return;

            // 1. Mark agreement as reached
            isAgreementReached = true;

            // 2. Append the final agreement message to the chat
            const agreementMessage = document.createElement('div');
            agreementMessage.classList.add('flex', 'justify-end');

            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            agreementMessage.innerHTML = `
                <div class="max-w-xs sm:max-w-md p-3 bg-green-500 text-white shadow-lg rounded-xl text-center">
                    <p class="font-bold text-base mb-1">AGREEMENT FINALIZED!</p>
                    <p class="text-sm">Confirming rental terms with Ayush Singh for Athena House at ₹8,500/month. Booking link generated for student.</p>
                    <span class="block text-xs text-green-200 text-right mt-1">${time}</span>
                </div>
            `;
            chatMessages.appendChild(agreementMessage);

            // 3. Hide Negotiation UI and Show Booking UI
            negotiationArea.classList.add('hidden');
            bookingArea.classList.remove('hidden');

            // 4. Auto-scroll
            scrollChatToBottom();
            
            console.log("Agreement Reached. Transitioning to Booking UI.");
        });
        
        // Logic for the 'Proceed to Booking' button (simulation)
        document.getElementById('proceed-booking-button').addEventListener('click', () => {
            console.log("REDIRECT: Redirecting owner to generate official booking documents.");
            // In a real app, this would navigate to a booking creation form.
            // alert is forbidden, so we'll simulate a feedback message in the console.
            console.log("ACTION: Owner has clicked 'Proceed to Booking Portal'.");
        });

        // Initial scroll to bottom when page loads
        window.onload = scrollChatToBottom;
    </script>
</body>
</html>
