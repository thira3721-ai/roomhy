<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Flow Test - RoomHy Chat System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/socket-chat.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; }
        .log-box { background: #1a1a1a; color: #0f0; max-height: 400px; overflow-y: auto; padding: 12px; border-radius: 4px; font-size: 12px; }
        .info { color: #87ceeb; }
        .success { color: #90ee90; }
        .error { color: #ff6b6b; }
        .warning { color: #ffd700; }
    </style>
</head>
<body class="p-8 bg-slate-900 text-white">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üîç Message Flow Test - RoomHy Chat System</h1>
        
        <div class="grid grid-cols-2 gap-8">
            <!-- Panel A: Sender -->
            <div class="bg-slate-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4">Panel A: Sender (Area Manager)</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">User ID:</label>
                        <input type="text" id="panelAUserId" value="MGR_AREA1" class="w-full px-3 py-2 bg-slate-700 rounded text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Chat With:</label>
                        <input type="text" id="panelAChatWith" value="OWNER001" class="w-full px-3 py-2 bg-slate-700 rounded text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Message:</label>
                        <input type="text" id="panelAMessage" value="Hello from Area Manager" class="w-full px-3 py-2 bg-slate-700 rounded text-white">
                    </div>
                    <button onclick="panelASendMessage()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-medium">Send Message</button>
                    <button onclick="panelAConnectSocket()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-medium">Connect Socket</button>
                    <button onclick="panelAJoinRoom()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-medium">Join Room</button>
                    <div class="mt-4">
                        <h3 class="font-bold mb-2">Status:</h3>
                        <div class="log-box">
                            <div id="panelAStatus" class="info">Waiting for initialization...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel B: Receiver -->
            <div class="bg-slate-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4">Panel B: Receiver (Property Owner)</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">User ID:</label>
                        <input type="text" id="panelBUserId" value="OWNER001" class="w-full px-3 py-2 bg-slate-700 rounded text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Listen From:</label>
                        <input type="text" id="panelBListenFrom" value="MGR_AREA1" class="w-full px-3 py-2 bg-slate-700 rounded text-white">
                    </div>
                    <button onclick="panelBConnectSocket()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-medium">Connect Socket</button>
                    <button onclick="panelBJoinRoom()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-medium">Join Room</button>
                    <div class="mt-4">
                        <h3 class="font-bold mb-2">Status & Received Messages:</h3>
                        <div class="log-box">
                            <div id="panelBStatus" class="info">Waiting for initialization...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Server Status -->
        <div class="mt-8 bg-slate-800 p-6 rounded-lg">
            <h2 class="text-xl font-bold mb-4">üîó Server Connection Status</h2>
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-slate-700 p-4 rounded">
                    <div class="text-sm text-gray-400">Server URL</div>
                    <div class="text-lg font-mono">localhost:5000</div>
                </div>
                <div class="bg-slate-700 p-4 rounded">
                    <div class="text-sm text-gray-400">Panel A Status</div>
                    <div id="panelAConnStatus" class="text-lg font-mono text-error">Disconnected</div>
                </div>
                <div class="bg-slate-700 p-4 rounded">
                    <div class="text-sm text-gray-400">Panel B Status</div>
                    <div id="panelBConnStatus" class="text-lg font-mono text-error">Disconnected</div>
                </div>
            </div>
        </div>

        <!-- Overall Log -->
        <div class="mt-8 bg-slate-800 p-6 rounded-lg">
            <h2 class="text-xl font-bold mb-4">üìã Overall Event Log</h2>
            <div class="log-box" id="overallLog" style="max-height: 300px;">
                <div class="info">System ready - Click 'Connect Socket' to start</div>
            </div>
        </div>
    </div>

    <script>
        let panelAChat = null;
        let panelBChat = null;

        function log(panelId, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            const logEntry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            
            const element = document.getElementById(`${panelId}Status`);
            if (element) {
                element.innerHTML += logEntry;
                element.parentElement.scrollTop = element.parentElement.scrollHeight;
            }
            
            const overallLog = document.getElementById('overallLog');
            overallLog.innerHTML += `<div class="${className}">[${timestamp}] ${panelId}: ${message}</div>`;
            overallLog.parentElement.scrollTop = overallLog.parentElement.scrollHeight;
        }

        // ==================== PANEL A: SENDER ====================
        async function panelAConnectSocket() {
            const userId = document.getElementById('panelAUserId').value;
            log('panelA', 'Initializing socket with user ID: ' + userId, 'info');
            
            panelAChat = new RoomHyChatSocket();
            panelAChat.init(userId);
            
            panelAChat.onConnect(() => {
                log('panelA', '‚úì Socket connected', 'success');
                document.getElementById('panelAConnStatus').innerHTML = '<span class="success">Connected</span>';
            });
            
            panelAChat.onDisconnect(() => {
                log('panelA', '‚úó Socket disconnected', 'error');
                document.getElementById('panelAConnStatus').innerHTML = '<span class="error">Disconnected</span>';
            });
            
            panelAChat.onMessage((data) => {
                log('panelA', 'Received message: ' + data.message + ' from ' + data.from, 'success');
            });
            
            // Wait for connection
            setTimeout(() => {
                if (panelAChat.isConnected) {
                    log('panelA', 'Ready to send messages', 'success');
                } else {
                    log('panelA', 'Connection failed or not yet established', 'error');
                }
            }, 1000);
        }

        function panelAJoinRoom() {
            if (!panelAChat || !panelAChat.isConnected) {
                log('panelA', 'Not connected yet', 'error');
                return;
            }
            const chatWith = document.getElementById('panelAChatWith').value;
            panelAChat.joinRoom(chatWith);
            log('panelA', 'Joined room with: ' + chatWith, 'info');
        }

        async function panelASendMessage() {
            if (!panelAChat || !panelAChat.isConnected) {
                log('panelA', 'Not connected', 'error');
                return;
            }
            const chatWith = document.getElementById('panelAChatWith').value;
            const message = document.getElementById('panelAMessage').value;
            
            log('panelA', 'Sending: ' + message, 'info');
            const success = await panelAChat.sendMessage(message, chatWith);
            
            if (success) {
                log('panelA', '‚úì Message sent successfully', 'success');
            } else {
                log('panelA', '‚úó Failed to send message', 'error');
            }
        }

        // ==================== PANEL B: RECEIVER ====================
        async function panelBConnectSocket() {
            const userId = document.getElementById('panelBUserId').value;
            log('panelB', 'Initializing socket with user ID: ' + userId, 'info');
            
            panelBChat = new RoomHyChatSocket();
            panelBChat.init(userId);
            
            panelBChat.onConnect(() => {
                log('panelB', '‚úì Socket connected', 'success');
                document.getElementById('panelBConnStatus').innerHTML = '<span class="success">Connected</span>';
            });
            
            panelBChat.onDisconnect(() => {
                log('panelB', '‚úó Socket disconnected', 'error');
                document.getElementById('panelBConnStatus').innerHTML = '<span class="error">Disconnected</span>';
            });
            
            panelBChat.onMessage((data) => {
                log('panelB', '‚úì RECEIVED MESSAGE: "' + data.message + '" from ' + data.from, 'success');
                log('panelB', 'Room: ' + data.roomId + ' | Type: ' + data.type, 'info');
            });
            
            setTimeout(() => {
                if (panelBChat.isConnected) {
                    log('panelB', 'Ready to receive messages', 'success');
                } else {
                    log('panelB', 'Connection failed or not yet established', 'error');
                }
            }, 1000);
        }

        function panelBJoinRoom() {
            if (!panelBChat || !panelBChat.isConnected) {
                log('panelB', 'Not connected yet', 'error');
                return;
            }
            const listenFrom = document.getElementById('panelBListenFrom').value;
            panelBChat.joinRoom(listenFrom);
            log('panelB', 'Joined room with: ' + listenFrom, 'info');
        }

        // Auto-log startup
        window.addEventListener('load', () => {
            log('panelA', 'Panel A ready', 'info');
            log('panelB', 'Panel B ready', 'info');
        });
    </script>
</body>
</html>
