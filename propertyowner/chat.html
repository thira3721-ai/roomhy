<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomHy - Property Owner Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>


</head>
<body class="bg-gray-50 font-sans">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-72 bg-gray-900 text-white flex flex-col">
            <div class="p-6 border-b border-gray-700">
                <h1 class="text-2xl font-bold">RoomHy Chat</h1>
                <p class="text-sm text-gray-400">Property Owner</p>
            </div>
            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <a href="dashboard.html" class="block px-4 py-2 rounded hover:bg-gray-800 transition">‚Üê Back to Dashboard</a>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase px-4 mb-3">Help Desk Chats</h3>
                    <div id="chatsList" class="space-y-1">
                        <!-- Chats loaded here -->
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <div>
                    <h2 id="chatHeader" class="text-xl font-bold text-gray-900">Select a chat to start messaging</h2>
                    <p id="chatSubheader" class="text-sm text-gray-500">Ready to communicate with Area Managers</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="closeBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 hidden">Close Chat</button>
                </div>
            </header>

            <!-- Messages Area -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
                <div class="text-center text-gray-500 mt-12">
                    <p>No chat selected. Select from the list to start messaging with Area Managers.</p>
                </div>
            </div>

            <!-- Message Input -->
            <div class="bg-white border-t border-gray-200 p-4">
                <div class="flex gap-3">
                    <input 
                        id="messageInput" 
                        type="text" 
                        placeholder="Type a message..." 
                        class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                        disabled
                    >
                    <button 
                        id="sendBtn" 
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2 disabled:opacity-50"
                        disabled
                    >
                        <i data-lucide="send" class="w-4 h-4"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // User info
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || localStorage.getItem('owner_user') || sessionStorage.getItem('owner_user') || '{}');
        const userId = user.owner_id || user.loginId || user.id || 'unknown';
        const userName = user.name || user.username || 'Property Owner';
        const userRole = 'property_owner';

        let currentChat = null;
        let currentChatId = null;
        let allChats = [];
        const apiUrl = window.location.hostname === 'localhost' 
            ? 'http://localhost:5002' 
            : window.location.origin;

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            if (!user || (user.role !== 'propertyowner' && user.role !== 'property_owner' && user.role !== 'owner')) {
                alert('Please login as a property owner');
                window.location.href = 'login.html';
                return;
            }

            // Join Socket.IO
            socket.emit('user_join', { user_id: userId, user_name: userName, user_role: userRole });

            // Load chats
            loadUserChats();
        });

        // ============ SOCKET EVENTS ============
        socket.on('new_message', (data) => {
            if (data.chat_id === currentChatId) {
                displayMessage(data);
            }
        });

        socket.on('user_typing', (data) => {
            if (data.chat_id === currentChatId && data.user_id !== userId) {
                document.getElementById('chatSubheader').textContent = `${data.user_name} is typing...`;
            }
        });

        socket.on('user_stop_typing', (data) => {
            if (data.chat_id === currentChatId) {
                document.getElementById('chatSubheader').textContent = 'Ready to chat';
            }
        });

        socket.on('chat_closed', (data) => {
            if (data.chat_id === currentChatId) {
                alert(`Chat closed by ${data.closed_by}.`);
                loadUserChats();
            }
        });

        // ============ FUNCTIONS ============
        async function loadUserChats() {
            try {
                const response = await fetch(`${apiUrl}/api/chats/user/${userId}`);
                const data = await response.json();

                if (data.success) {
                    allChats = data.chats || [];
                    filterAndDisplayChats();
                } else {
                    document.getElementById('chatsList').innerHTML = '<p class="text-gray-500 text-sm p-4">No chats available</p>';
                }
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        function filterAndDisplayChats() {
            const chatsList = document.getElementById('chatsList');
            if (allChats.length === 0) {
                chatsList.innerHTML = '<p class="text-gray-500 text-sm p-4">No help desk chats yet</p>';
                return;
            }

            chatsList.innerHTML = allChats.map(chat => `
                <button 
                    onclick="selectChat('${chat.chat_id}')"
                    class="w-full text-left px-4 py-2 rounded hover:bg-gray-800 transition text-sm"
                >
                    <div class="font-medium truncate">${chat.property_name || 'Help Desk Chat'}</div>
                    <div class="text-xs text-gray-400">üí¨ Area Manager Support</div>
                    <div class="text-xs text-gray-500 truncate">${chat.messages?.length || 0} messages</div>
                </button>
            `).join('');
        }

        async function selectChat(chatId) {
            currentChatId = chatId;

            try {
                const response = await fetch(`${apiUrl}/api/chats/messages/${chatId}`);
                const data = await response.json();

                if (data.success) {
                    // Get chat details
                    const chat = allChats.find(c => c.chat_id === chatId);

                    // Update header
                    document.getElementById('chatHeader').textContent = chat.property_name || 'Help Desk Chat';
                    document.getElementById('chatSubheader').textContent = 'Help Desk Support';

                    // Display messages
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = data.messages.map(msg => `
                        <div class="flex ${msg.sender_role === 'system' ? 'justify-center' : msg.sender_id === userId ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs ${msg.sender_role === 'system' ? 'bg-yellow-50 border border-yellow-200 text-yellow-900 text-center' : msg.sender_id === userId ? 'bg-blue-600 text-white' : 'bg-white text-gray-900'} rounded-lg p-3 shadow">
                                ${msg.sender_role !== 'system' ? `<p class="text-xs font-semibold opacity-90">${msg.sender_name}</p>` : ''}
                                <p class="text-sm mt-1">${msg.message}</p>
                                <p class="text-xs ${msg.sender_id === userId ? 'text-blue-200' : msg.sender_role === 'system' ? 'text-yellow-700' : 'text-gray-500'} mt-1">
                                    ${new Date(msg.timestamp).toLocaleTimeString()}
                                </p>
                            </div>
                        </div>
                    `).join('');

                    // Enable input
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('closeBtn').classList.remove('hidden');

                    // Join Socket.IO room
                    socket.emit('join_chat', { chat_id: chatId, user_id: userId, user_name: userName, user_role: userRole });

                    // Scroll to bottom
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            } catch (error) {
                console.error('Error selecting chat:', error);
            }
        }

        function displayMessage(data) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `flex ${data.sender_id === userId ? 'justify-end' : 'justify-start'}`;
            messageEl.innerHTML = `
                <div class="max-w-xs ${data.sender_id === userId ? 'bg-blue-600 text-white' : 'bg-white text-gray-900'} rounded-lg p-3 shadow">
                    <p class="text-xs font-semibold opacity-90">${data.sender_name}</p>
                    <p class="text-sm mt-1">${data.message}</p>
                    <p class="text-xs ${data.sender_id === userId ? 'text-blue-200' : 'text-gray-500'} mt-1">
                        ${new Date(data.timestamp).toLocaleTimeString()}
                    </p>
                </div>
            `;
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        // ============ EVENT LISTENERS ============
        document.getElementById('sendBtn').addEventListener('click', () => {
            const message = document.getElementById('messageInput').value.trim();
            if (!message || !currentChatId) return;

            socket.emit('send_message', {
                chat_id: currentChatId,
                sender_id: userId,
                sender_name: userName,
                sender_role: userRole,
                message
            });

            document.getElementById('messageInput').value = '';
        });

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendBtn').click();
            }
        });

        document.getElementById('closeBtn').addEventListener('click', () => {
            if (confirm('Close this chat? You can reopen it later.')) {
                socket.emit('close_chat', {
                    chat_id: currentChatId,
                    closed_by: userName,
                    reason: 'Property Owner closed the chat'
                });
            }
        });

        lucide.createIcons();
    </script>
</body>
</html>